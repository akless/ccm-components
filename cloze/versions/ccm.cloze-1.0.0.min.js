(function(){var filename="ccm.cloze-1.0.0.min.js";var ccm_version="8.1.0";var ccm_url="https://akless.github.io/ccm/version/ccm-8.1.0.min.js";var component_name="cloze";var component_obj={name:component_name,version:[1,0,0],config:{text:"Hello, [[(W)o(rl)d]]!",html_templates:{start:{id:"start",inner:{tag:"button",inner:"%caption%",onclick:"%click%"}},main:{id:"main",inner:[{id:"keywords"},{id:"text"},{id:"buttons",inner:[{id:"cancel"},{id:"submit"},{id:"finish"},{id:"timer"}]}]},keyword:{"class":"keyword",inner:"%%"},timer:{tag:"span",inner:"%%"}},css:["ccm.load","https://akless.github.io/ccm-components/resources/default.css"],placeholder:{start:"Start",cancel:"Cancel",submit:"Submit",finish:"Finish"}},Instance:function(){var self=this;var my;var keywords=[];this.init=function(callback){if(self.node&&self.node.innerHTML.trim())self.text=self.node.innerHTML;callback()};this.ready=function(callback){my=self.ccm.helper.privatize(self);var regex_keyword=/\[\[.+?\]\]/g;var regex_given=/\(.+?\)/g;(my.text.match(regex_keyword)||[]).map(function(keyword){keyword=keyword.substr(2,keyword.length-4);var keyw__d=keyword.replace("*","#").replace(regex_given,function(given){var length=given.length-2;given="";for(var i=0;i<length;i++)given+="*";return given});var givens=0;for(var i=0;i<keyw__d.length;i++)if(keyw__d.charAt(i)==="*")givens+=Math.pow(2,i);keywords.push({word:keyword.replace(regex_given,function(given){return given.substr(1,given.length-2)}),givens:givens})});my.text=my.text.replace(regex_keyword,'<span class="gap"></span>');callback()};this.start=function(callback){if(self.logger)self.logger.log("render");if(my.start_button){self.ccm.helper.setContent(self.element,self.ccm.helper.protect(self.ccm.helper.html(my.html_templates.start,{caption:my.placeholder.start,click:start})))}else start();if(callback)callback();function start(){var results={details:[]};if(self.logger)self.logger.log("start",my);var main_elem=self.ccm.helper.html(my.html_templates.main);var text_elem=main_elem.querySelector("#text");var cancel_elem=main_elem.querySelector("#cancel");var submit_elem=main_elem.querySelector("#submit");var finish_elem=main_elem.querySelector("#finish");var timer_elem=main_elem.querySelector("#timer");if(!my.cancel_button)self.ccm.helper.removeElement(cancel_elem);if(!my.feedback)self.ccm.helper.removeElement(submit_elem);renderKeywords();renderText();updateButtons();renderTimer();self.ccm.helper.setContent(self.element,self.ccm.helper.protect(main_elem));if(self.onstart)self.onstart(self);function renderKeywords(){var keywords_elem=main_elem.querySelector("#keywords");var entries=[];if(my.keywords)(Array.isArray(my.keywords)?my.keywords:keywords).map(addKeyword);else return self.ccm.helper.removeElement(keywords_elem);if(my.keywords===true)entries.sort(function(a,b){return a.innerHTML.localeCompare(b.innerHTML)});entries.map(function(entry){keywords_elem.appendChild(entry)});function addKeyword(keyword){entries.push(self.ccm.helper.html(my.html_templates.keyword,Array.isArray(my.keywords)?keyword:keyword.word))}}function renderText(){text_elem.innerHTML=my.text;self.ccm.helper.makeIterable(main_elem.querySelectorAll(".gap")).map(function(gap_elem,i){if(my.blank&&my.keywords)return gap_elem.appendChild(self.ccm.helper.html({tag:"input",type:"text",oninput:onInput,onchange:onChange}));var keyword=keywords[i].word;var input={tag:"input",type:"text",oninput:onInput,onchange:onChange,maxlength:keyword.length,size:keyword.length*1.5};if(!my.blank){input.placeholder="";for(var j=0;j<keyword.length;j++)input.placeholder+=Math.pow(2,j)&keywords[i].givens?keyword.charAt(j):"_"}gap_elem.appendChild(self.ccm.helper.html(input));function onInput(){var event_data={gap:1+i,input:this.value};if(self.logger)self.logger.log("input",event_data);if(self.oninput)self.oninput(self,event_data)}function onChange(){var event_data={gap:1+i,input:this.value};if(self.logger)self.logger.log("change",event_data);if(self.onchange)self.onchange(self,event_data)}})}function updateButtons(){if(my.cancel_button)self.ccm.helper.setContent(cancel_elem,self.ccm.helper.protect(self.ccm.helper.html({tag:"button",inner:my.placeholder.cancel,onclick:function(){if(self.oncancel)self.oncancel(self);else self.start(callback)}})));if(my.feedback)self.ccm.helper.setContent(submit_elem,self.ccm.helper.protect(self.ccm.helper.html({tag:"button",disabled:results.details.length>0,inner:my.placeholder.submit,onclick:evaluate})));self.ccm.helper.setContent(finish_elem,self.ccm.helper.protect(self.ccm.helper.html({tag:"button",inner:my.placeholder.finish,onclick:onFinish})));function evaluate(){self.ccm.helper.makeIterable(main_elem.querySelectorAll(".gap input")).map(function(gap,i){var event_data={gap:1+i,input:gap.value};var nearly=gap.value.toLowerCase().trim()===keywords[i].word.toLowerCase().trim();var correct=gap.value===keywords[i].word;if(self.onvalidation&&!self.onvalidation(self,self.ccm.helper.clone(event_data)))return results.details=[];event_data.solution=keywords[i].word;gap.disabled=true;if(!nearly)gap.value="";gap.setAttribute("placeholder",keywords[i].word);gap.parentNode.classList.add(correct?"correct":nearly?"nearly":"wrong");results.details.push(event_data)});if(results.details.length===0)return;if(self.logger)self.logger.log("feedback",results);if(self.onfeedback)self.onfeedback(self,self.ccm.helper.clone(results));updateButtons()}}function renderTimer(){if(!my.time)return self.ccm.helper.removeElement(timer_elem);var timer_value=my.time;timer();function timer(){if(!finish_elem)return;self.ccm.helper.setContent(timer_elem,self.ccm.helper.html(my.html_templates.timer,timer_value));if(timer_value--)self.ccm.helper.wait(1e3,timer);else onFinish()}}function onFinish(){if(self.user)self.user.login(proceed);else proceed();function proceed(){self.ccm.helper.removeElement(finish_elem);self.ccm.helper.removeElement(timer_elem);if(self.user)results.user=self.user.data().user;if(self.logger)self.logger.log("finish",results);self.ccm.helper.onFinish(self,results)}}}}}};if(window.ccm&&window.ccm.files)window.ccm.files[filename]=component_obj;var namespace=window.ccm&&ccm.components[component_name];if(namespace){if(namespace.ccm_version)ccm_version=namespace.ccm_version;if(namespace.ccm_url)ccm_url=namespace.ccm_url}if(!window.ccm||!ccm[ccm_version]){var tag=document.createElement("script");document.head.appendChild(tag);tag.onload=register;tag.src=ccm_url}else register(true);function register(synchron){ccm[ccm_version].component(component_obj);if(!synchron)delete window.ccm.files[filename]}})();