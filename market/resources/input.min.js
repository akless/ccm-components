ccm.component({index:"input",config:{data:{store:[ccm.store,"./resources/inputs.json"],key:"demo"}},Instance:function(){var self=this;var my;this.ready=function(callback){my=ccm.helper.privatize(self,"data","edit","bigdata","form","fieldset","onFinish");callback()};this.render=function(callback){var $element=ccm.helper.element(self);if(self.user)self.user.login(proceed);else proceed();function proceed(){ccm.helper.dataset(my.data,function(dataset){var key=hasEditstore()&&my.edit.key;if(hasEditstore()&&!my.edit.key)my.edit.key=ccm.helper.generateKey();if(self.user&&hasEditstore())my.edit.key=[my.edit.key,self.user.data().key];ccm.helper.dataset(my.edit,function(editset){if(self.user&&hasEditstore())my.edit.key=editset.key=editset.key[0];var html=[{class:"inputs",inner:[]}];generateInputs();generateFieldset();generateForm();$element.html(ccm.helper.html(html,submit));if(my.bigdata)my.bigdata.log("render",{data:ccm.helper.dataSource(my.data),edit:ccm.helper.dataSource(my.edit)});if(callback)callback();function generateInputs(){if(dataset.inputs)if(Array.isArray(dataset.inputs))dataset.inputs.map(addInput);else addInput(dataset.inputs);function addInput(input){if(editset)integrate(ccm.helper.value(editset,input.name));var label=input.label||input.name;delete input.label;if(input.name==="key"){input.input="text";input.pattern=ccm.helper.regex("key").toString().slice(1,-1);if(editset)input.value=editset.key;input.required=true}switch(input.input){case"select":case"textarea":input.tag=input.input;if(input.value&&!input.inner){input.inner=input.value;delete input.value}break;default:input.tag="input";input.type=input.input}if(input.input==="radio"){for(var i=0;i<input.values.length;i++){input.values[i].tag=input.tag;input.values[i].type=input.type;input.values[i].name=input.name;input.values[i]={tag:"label",inner:[input.values[i],{tag:"span",inner:"&nbsp;"},{tag:"span",inner:input.values[i].caption||input.values[i].value},{tag:"br"}]};delete input.values[i].inner[0].caption}input=input.values}if(input.input==="checkbox"){if(input.values){for(var i=0;i<input.values.length;i++){input.values[i].tag=input.tag;input.values[i].type=input.type;input.values[i].value=input.values[i].value||input.values[i].name;input.values[i]={tag:"label",inner:[input.values[i],{tag:"span",inner:"&nbsp;"},{tag:"span",inner:input.values[i].caption||input.values[i].value},{tag:"br"}]};delete input.values[i].inner[0].caption}input=input.values}else{input.id=self.index+"-"+input.name;label={tag:"label",for:input.id,inner:label};input=[input,{tag:"span",inner:"&nbsp;"},{tag:"span",inner:input.caption}];delete input[0].caption}}if(input.input==="select"){input.inner=input.options;delete input.options;for(var i=0;i<input.inner.length;i++){input.inner[i].tag="option";input.inner[i].inner=input.inner[i].caption||input.inner[i].value;delete input.inner[i].caption}}if(input.input==="range"){input.oninput=function(){jQuery(this).next().next().text(jQuery(this).val())};input=[input,{tag:"span",inner:"&nbsp;"},{tag:"span",inner:input.value||(parseInt(input.min)||0)+(parseInt(input.max)||100)/2}]}delete input.input;html[0].inner.push({class:"entry",inner:[{class:"label",inner:label},{class:"input",inner:input}]});function integrate(value){if(value===undefined)return;switch(input.input){case"radio":case"checkbox":delete input.checked;for(var i=0;i<input.values.length;i++){delete input.values[i].checked;if(input.values[i].value===value||input.values[i].caption===value)input.values[i].checked=true}break;case"select":for(var i=0;i<input.options.length;i++){delete input.options[i].selected;if(input.options[i].value===value)input.options[i].selected=true}break;case"textarea":input.inner=value;break;default:input.value=value}}}}function generateFieldset(){if(my.fieldset){html={tag:"fieldset",inner:html};if(typeof my.fieldset==="string")html.inner.unshift({tag:"legend",inner:my.fieldset})}}function generateForm(){if(my.form){html={tag:"form",onsubmit:"%%",inner:html};var button={tag:"input",type:"submit",value:my.form};if(button.value===true)delete button.value;if(my.fieldset)html.inner.inner.push(button);else html.inner.push(button)}}function submit(){var result=convert(ccm.helper.formData(jQuery(this)));if(self.user)self.user.login(proceed);else proceed();return false;function proceed(){if(hasEditstore()){if(result.key){if(result.key!==editset.key)my.edit.store.del(self.user?[editset.key,self.user.data().key]:editset.key)}result.key=editset.key}if(my.bigdata)my.bigdata.log("finish",{data:ccm.helper.dataSource(my.data),edit:ccm.helper.dataSource(my.edit),result:result});if(self.user&&hasEditstore())result.key=[result.key,self.user.data().key];if(!hasEditstore()||my.edit.no_set)return performCallback(result);if(hasEditstore()&&Object.keys(editset).length===1&&my.edit.permission)result._=my.edit.permission;my.edit.store.set(result,performCallback);function performCallback(result){if(self.user&&hasEditstore())my.edit.key=editset.key=editset.key[0];if(hasEditstore()&&!key){delete my.edit.key;self.render()}if(my.onFinish)my.onFinish(result)}}function convert(obj){var keys=Object.keys(obj);for(var i=0;i<keys.length;i++)if(keys[i].indexOf(".")!==-1){ccm.helper.value(obj,keys[i],obj[keys[i]]);delete obj[keys[i]]}return obj}}});function hasEditstore(){return!!ccm.helper.isObject(my.edit)&&ccm.helper.isDatastore(my.edit.store)}})}}}});