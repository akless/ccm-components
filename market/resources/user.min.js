ccm.component({name:"user",config:{html:{logged_in:[{class:"username",inner:"%%",tag:"span",title:"%%"},{class:"logout",inner:"%%",onclick:"%%",tag:"button",title:"%%"}],logged_out:{class:"login",inner:"%%",onclick:"%%",tag:"button",title:"%%"}},sign_on:"hbrsinfkaul",context:true,logged_in:false,texts:{login:"Login",login_title:"click here for login",logout:"Logout",logout_title:"click here for logout",username_title:"this is your username"}},Instance:function(){var dataset=null;var timer=null;var observers=[];var self=this;var sign_on;var loading=false;var waitlist=[];this.init=function(callback){if(self.context){var context=ccm.context.find(self,"user");self.context=context&&context.context||context}sign_on=self.sign_on;delete self.sign_on;callback()};this.ready=function(callback){if(self.logged_in)self.login();callback()};this.renew_token=function(callback){ccm.load(["https://kaul.inf.h-brs.de/login/login.php",{realm:"hbrsinfkaul"}],function(response){if(dataset)dataset.token=response.token;if(callback)callback(response)})};this.render=function(callback){if(self.context)return self.context.render(callback);var element=ccm.helper.element(self);if(self.isLoggedIn())element.html(ccm.helper.html(self.html.logged_in,ccm.helper.val(self.data().key),ccm.helper.val(self.texts.username_title),ccm.helper.val(self.texts.logout),clickLogout,ccm.helper.val(self.texts.logout_title)));else element.html(ccm.helper.html(self.html.logged_out,ccm.helper.val(self.texts.login),clickLogin,ccm.helper.val(self.texts.login_title)));if(self.lang)self.lang.render();if(callback)callback();function clickLogin(){self.login(function(){self.render()})}function clickLogout(){self.logout(function(){self.render()})}};this.login=function(callback){if(self.context)return self.context.login(callback);if(self.isLoggedIn()){if(callback)callback();return}if(loading)return waitlist.push([self.login,callback]);loading=true;switch(sign_on){case"demo":ccm.load(["https://kaul.inf.h-brs.de/login/demo_login.php",{realm:"hbrsinfkaul"}],function(response){success(response.user,response.token)});break;case"hbrsinfkaul":self.renew_token(function(response){var expiration_seconds=response.expiration_seconds;var millisTillExpiration=expiration_seconds*1e3;if(timer){window.clearTimeout(timer);timer=null}timer=window.setTimeout(self.renew_token,millisTillExpiration);success(response.user,response.token,response.name)});break}function success(key,token,name){dataset={key:key,token:token,name:name};while(waitlist.length>0)ccm.helper.action(waitlist.shift());loading=false;if(ccm.helper.isInDOM(self))self.render();if(callback)callback();notify(true)}};this.logout=function(callback){if(self.context)return self.context.logout(callback);if(!self.isLoggedIn()){if(callback)callback();return}switch(sign_on){case"demo":ccm.load(["https://logout@kaul.inf.h-brs.de/login/demo_logout.php",{realm:"hbrsinfkaul"}]);success();break;case"hbrsinfkaul":ccm.load(["https://kaul.inf.h-brs.de/login/logout.php",{realm:"hbrsinfkaul"}]);success();break}function success(){dataset=null;if(ccm.helper.isInDOM(self))self.render();if(callback)callback();notify(false)}};this.isLoggedIn=function(){if(self.context)return self.context.isLoggedIn();return!!dataset};this.data=function(){if(self.context)return self.context.data();return dataset};this.getSignOn=function(){if(self.context)return self.context.getSignOn();return sign_on};this.addObserver=function(observer){if(self.context)return self.context.addObserver(observer);observers.push(observer)};function notify(event){for(var i=0;i<observers.length;i++)observers[i](event)}}});