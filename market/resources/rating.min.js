ccm.component({name:"rating",config:{icons:[ccm.load,"https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"],key:"demo",mode:"thumbs",store:[ccm.store,"./json/rating.json"],style:[ccm.load,"./css/rating.css"],user:[ccm.instance,"./components/user.js"]},Instance:function(){var self=this;this.init=function(callback){self.store.onChange=function(){self.render()};callback()};this.ready=function(callback){if(self.user)self.user.addObserver(function(){self.render()});callback()};this.render=function(callback){var element=ccm.helper.element(self);element.html(ccm.helper.html({class:"rating"}));ccm.helper.dataset(self,function(dataset){if(self.mode==="thumbs")renderThumbs();if(self.mode==="stars")renderStars();if(callback)callback();function renderThumbs(){if(!dataset.likes)dataset.likes={};if(!dataset.dislikes)dataset.dislikes={};ccm.helper.find(self,".rating").html('<div class="likes fa fa-lg fa-thumbs-up">'+"<div>"+(dataset.likes?Object.keys(dataset.likes).length:0)+"</div>"+"</div>&nbsp;"+'<div class="dislikes fa fa-lg fa-thumbs-down">'+" <div>"+(dataset.dislikes?Object.keys(dataset.dislikes).length:0)+"</div>"+"</div>");var rating_div=ccm.helper.find(self,".rating");if(!self.user)return;var div={likes:ccm.helper.find(self,rating_div,".likes"),dislikes:ccm.helper.find(self,rating_div,".dislikes")};rating_div.addClass("user");if(self.user.isLoggedIn()){var user=self.user.data().key;if(dataset.likes[user])div["likes"].addClass("selected");if(dataset.dislikes[user])div["dislikes"].addClass("selected")}click("likes","dislikes");click("dislikes","likes");function click(index,other){div[index].click(function(){self.user.login(function(){var user=self.user.data().key;if(dataset[index][user]){delete dataset[index][user]}else{dataset[index][user]=true;delete dataset[other][user]}self.store.set(dataset,function(){self.render()})})})}}function renderStars(){if(!dataset.stars)dataset.stars={};if(!dataset.star_vote)dataset.star_vote="0";var rating_div=ccm.helper.find(self,".rating");rating_div.html("");var star;var rating=Math.round(dataset.star_vote);if(self.user&&self.user.isLoggedIn()){if(dataset.stars[self.user.data().key])rating=dataset.stars[self.user.data().key];else rating=0}for(var i=1;i<=5;i++){if(rating>=i)star=jQuery("<div>&#9733;</div>");else star=jQuery("<div>&#9734;</div>");star.on("click",click());rating_div.append(star)}rating_div.append("&nbsp;("+(self.user?dataset.star_vote:Object.keys(dataset.stars).length)+")");function click(){return function(){var star_selected=jQuery(this).index();if(self.user){self.user.login(function(){var user=self.user.data().key;jQuery(this).addClass("selected");dataset.stars[user]=star_selected+1;var votes=0;for(var key in dataset.stars)votes+=dataset.stars[key];dataset.star_vote=Math.round(votes/Object.keys(dataset.stars).length*10)/10;self.store.set(dataset,function(){self.render()})})}}}}})}}});