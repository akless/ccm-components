(function(){var component={name:"teambuild",ccm:"https://akless.github.io/ccm/ccm.js",config:{html:{main:{tag:"main",class:"teams"},team:{tag:"article",class:"team",inner:[{tag:"header",inner:[{class:"icon fa fa-%icon% fa-lg"},{class:"name",inner:"%name%"},{class:"button"},{class:"status"}]},{tag:"section",class:"members"}]},join:{tag:"button",inner:"%caption%",onclick:"%click%"},leave:{tag:"button",inner:"%caption%",onclick:"%click%"},member:{class:"member",inner:[{class:"icon fa fa-%icon%"},{class:"name",inner:"%name%"}]}},css:["ccm.load","../teambuild/resources/default.css"],icons:["ccm.load",{context:"head",url:"https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css",integrity:"sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+",crossorigin:"anonymous"},{url:"https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css",integrity:"sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+",crossorigin:"anonymous"}],data:{store:["ccm.store"]},text:{team:"Team",leave:"leave",join:"join",free:"free"},icon:{team:"group",member:"user"},editable:{join:true,leave:true,rename:true}},Instance:function(){var self=this;var my;this.init=function(callback){if(self.data.store)self.data.store.onchange=function(){self.start()};callback()};this.ready=function(callback){my=self.ccm.helper.privatize(self);if(self.user)self.user.addObserver(self.index,function(){self.start()});if(self.logger)self.logger.log("ready",function(){var data=self.ccm.helper.clone(my);if(data.data&&data.data.store)data.data.store=data.data.store.source();return data}());callback()};this.start=function(callback){self.ccm.helper.dataset(my.data,function(dataset){if(!dataset.teams)dataset.teams=[];var main_elem=self.ccm.helper.html(my.html.main);addTeams();self.ccm.helper.setContent(self.element,main_elem);if(self.logger)self.logger.log("start",dataset);if(callback)callback();function addTeams(){dataset.teams.map(addTeam);if(my.max_teams){var needed=my.max_teams-dataset.teams.length;for(var i=0;i<needed;i++)addEmptyTeam()}else if((dataset.teams.length===0||!isEmptyTeam(dataset.teams[dataset.teams.length-1]))&&joinableTeams())addEmptyTeam();function addTeam(team,i){if(i===undefined)i=dataset.teams.length-1;var team_elem=self.ccm.helper.html(my.html.team,{icon:my.icon.team,name:team.name?team.name:my.names&&my.names[i]?my.names[i]:my.text.team+" "+(i+1)});var max_members=team.max_members||my.max_members;var user;var user_team;if(self.user&&self.user.isLoggedIn()){user=self.ccm.helper.filterProperties(self.user.data(),"id","name","email");user_team=getUserTeam();if(isMember(team)){if(isEditable(i,"rename"))makeEditable();if(isEditable(i,"leave"))addLeaveButton()}else if(isJoinable())addJoinButton()}addMembers();main_elem.appendChild(team_elem);function getUserTeam(){for(var i=0;i<dataset.teams.length;i++)if(dataset.teams[i].members[user.id])return i+1}function isMember(team){return!!team.members[user.id]}function isEditable(team,action){if(team.editable===undefined)return!(my.editable===false||my.editable&&my.editable[action]===false);else return!(team.editable===false||team.editable&&team.editable[action]===false)}function makeEditable(){var name_elem=team_elem.querySelector(".name");name_elem.setAttribute("contenteditable",true);name_elem.addEventListener("input",function(){loading(true);var value=name_elem.textContent.trim();team.name=self.ccm.helper.protect(value);my.data.store.set(dataset,function(){loading(false);if(self.logger)self.logger.log("rename",{team:team.key,name:team.name})})})}function addLeaveButton(){self.ccm.helper.setContent(team_elem.querySelector(".button"),self.ccm.helper.html(my.html.leave,{icon:my.icon.leave,caption:my.text.leave,click:function(){loading(true);delete team.members[user.id];if(!my.max_teams&&isEmptyTeam(team))dataset.teams.splice(i,1);my.data.store.set(dataset,function(){if(self.logger)self.logger.log("leave",{team:team.key});self.start()})}}))}function isJoinable(){if(!isEditable(i,"join"))return false;if(user_team&&!isEditable(user_team-1,"leave"))return false;if(!my.max_teams&&i===dataset.teams.length-1&&i>0){if(isOnlyMember(dataset.teams[i-1]))return false;function isOnlyMember(team){return team.members[user.id]&&Object.keys(team.members).length===1}}return!max_members||Object.keys(team.members).length<max_members}function addJoinButton(){self.ccm.helper.setContent(team_elem.querySelector(".button"),self.ccm.helper.html(my.html.join,{icon:my.icon.join,caption:my.text.join,click:function(){loading(true);if(user_team){var leaving_team=dataset.teams[user_team-1];delete leaving_team.members[user.id];if(!my.max_teams&&isEmptyTeam(leaving_team))dataset.teams.splice(user_team-1,1)}team.members[user.id]=self.ccm.helper.cleanObject({id:user.id,name:user.name,email:user.email});my.data.store.set(dataset,function(){if(self.logger)self.logger.log("join",function(){var data={team:team.key};if(user_team)data.leaved=leaving_team.key;return data}());self.start()})}}))}function loading(show_or_hide){self.ccm.helper.setContent(team_elem.querySelector(".status"),show_or_hide?self.ccm.helper.loading(self):"")}function addMembers(){for(var member in team.members)addMember(team.members[member]);for(var i=0;i<max_members-Object.keys(team.members).length;i++)addMember();function addMember(member){var member_elem=self.ccm.helper.html(my.html.member,{icon:my.icon.member,name:member?member.email&&user.id!==member.id?'<a href="mailto:'+member.email+'">'+member.name+"</a>":member.name:my.text.free});var member_name_elem=member_elem.querySelector(".name");if(user&&member&&user.id===member.id)member_name_elem.classList.add("user");if(!member)member_name_elem.classList.add("free");team_elem.querySelector(".members").appendChild(member_elem)}}}function isEmptyTeam(team){return Object.keys(team.members).length===0}function addEmptyTeam(){var team={key:self.ccm.helper.generateKey(),members:{}};dataset.teams.push(team);addTeam(team)}function joinableTeams(){return!(my.editable===false||my.editable&&my.editable.join===false)}}})}}};function p(){window.ccm[v].component(component)}var f="ccm."+component.name+(component.version?"-"+component.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[f])window.ccm.files[f]=component;else{var n=window.ccm&&window.ccm.components[component.name];n&&n.ccm&&(component.ccm=n.ccm),"string"==typeof component.ccm&&(component.ccm={url:component.ccm});var v=component.ccm.url.split("/").pop().split("-");if(v.length>1?(v=v[1].split("."),v.pop(),"min"===v[v.length-1]&&v.pop(),v=v.join(".")):v="latest",window.ccm&&window.ccm[v])p();else{var e=document.createElement("script");document.head.appendChild(e),component.ccm.integrity&&e.setAttribute("integrity",component.ccm.integrity),component.ccm.crossorigin&&e.setAttribute("crossorigin",component.ccm.crossorigin),e.onload=function(){p(),document.head.removeChild(e)},e.src=component.ccm.url}}})();